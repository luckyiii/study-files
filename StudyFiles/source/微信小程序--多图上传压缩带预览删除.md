### 微信小程序--多图上传压缩带预览删除

压缩图片借用canvas进行绘图压缩

wxml

```
<!--miniprogram/pages/index/index.wxml-->
<view class="container">
  <view class='camera-btn' bindtap='chooseImage'>
    <image src='/images/camera-btn-bg.png'></image>
  </view>
  <view class="image-wrap">
    <block wx:for="{{pics}}" wx:key="*this">
  　  <view class="q_image_wrap">
  　　　<image class="q_image" src="{{item}}" mode="aspectFill" data-idx="{{index}}" bindtap="handleImagePreview">
        <!--删除-->
          <view class="q_image_remover" data-idx="{{index}}" bindtap="removeImage">
　　　　　　<image src="/images/delete.png" class="icon" />
　　　　　</view>
        </image>
  　　</view>
  　</block>
  </view>
</view>
<canvas canvas-id='attendCanvasId' class='myCanvas' style='width:{{canvasWidth}}px;height:{{canvasHeight}}px;position: fixed;top: -9999px;left: -9999px;'></canvas>


```

wxss

```
/* miniprogram/pages/index/index.wxss */
.container {
  width: 100%;
  height: 1000rpx;
  position: relative;
  padding: 0;
}
.camera-btn {
  height: 120rpx;
  background: #60d0fe;
  width: 100%;
  position: absolute;
  top: 0;
}
.camera-btn image {
  width: 120rpx;
  height: 120rpx;
  float: right;
}
.image-wrap {
  margin: 0;
  padding: 0;
  margin-top: 100rpx;
}
.q_image_wrap {
  margin: 0 20rpx 20rpx 0;
  width: 200rpx;
  height: 200rpx;
  float: left;
}
.q_image {
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: 10rpx;
}
.q_image_remover {
  position: absolute;
  bottom: 50rpx;
  right: 0;
  width: 50rpx;
  height: 50rpx;
}
.icon {
  width: 100%;
  height: 100%;
  background: red;
}
```

js

```
// miniprogram/pages/index/index.js
Page({
  data: {
    pics: [],
    imagesPress: [],
    canvasHeight: "",
    canvasWidth: ""
  },
  chooseImage: function () {
    const that = this;
    wx.chooseImage({
      count: 9-that.data.pics.length,
      sizeType: ['original', 'compressed'],
      sourceType: ['album', 'camera'],
      success (res) {
        // tempFilePath可以作为img标签的src属性显示图片
        for (var i = 0; i < res.tempFiles.length; i++) {
          if (res.tempFiles[i].size >= 10 * 1024 * 1024) {
              console.log('请上传10M以内的图片');
              return;
          }
        }
        let imgsrc = res.tempFilePaths;
        that.setData({
          pics: imgsrc
        });
        that.getCanvasImg(0, 0, res.tempFilePaths);
      }
    })
  },
  getCanvasImg: function (index, failNum, tempFilePaths) {
    var that = this;
    let imagesPress = that.data.imagesPress;
    if (index < tempFilePaths.length) {
      wx.getImageInfo({
        src: tempFilePaths[index],
        success: function (res) {
        //---------利用canvas压缩图片--------------
          var ratio = 2;
          var canvasWidth = res.width //图片原始长宽
          var canvasHeight = res.height
          while (canvasWidth > 400 || canvasHeight > 400) {// 保证宽高在400以内
              canvasWidth = Math.trunc(res.width / ratio)
              canvasHeight = Math.trunc(res.height / ratio)
              ratio++;
          }
          that.setData({
              canvasWidth: canvasWidth,
              canvasHeight: canvasHeight,
          })
          const ctx = wx.createCanvasContext('photo_canvas');
          // console.log(ctx);
          ctx.drawImage(tempFilePaths[index], 0, 0, canvasWidth, canvasHeight);
          ctx.draw(false, function () {
            
              index = index + 1;//上传成功的数量，上传成功则加1
              console.log("1")
              //自定义组件使用canvasToTempFilePath要加上this：wx.canvasToTempFilePath({},this)
              wx.canvasToTempFilePath({
                canvasId: 'photo_canvas',
                success: function success(res) {
                    // console.log('最终图片路径' + res.tempFilePath)//最终图片路径
                    imagesPress.push(res.tempFilePath);
                    
                    that.setData({
                        imagesPress: imagesPress
                    })
                    
                    that.uploadCanvasImg(res.tempFilePath);
                    // console.log(res.tempFilePath)
                    that.getCanvasImg(index, failNum, tempFilePaths);//递归压缩
                }, fail: function (e) {
                    failNum += 1;//失败数量，可以用来提示用户
                    that.getCanvasImg(inedx, failNum, tempFilePaths);
              }
            });
          });
        }
      })

    }
  },
  uploadCanvasImg: function (canvasImg) {
    console.log(canvasImg)
    wx.showLoading({
        title: '上传中...',
    });
    wx.cloud.uploadFile({
      cloudPath: "images/" + Date.now() + ".jpg",
      filePath: canvasImg
    }).then(res=>{
        wx.hideLoading();
        wx.showToast({
          title: '上传成功'
        })
        console.log(res)
    })
  },
  handleImagePreview(e) {
    const idx = e.target.dataset.idx
    const pics = this.data.pics
    wx.previewImage({
        current: pics[idx],  //当前预览的图片
        urls: pics,  //所有要预览的图片
    })
  },
  removeImage(e) {
    const that = this;
    let pics = that.data.pics;
    let imagesPress = that.data.imagesPress;
    console.log(pics)
    // 获取要删除的第几张图片的下标
    const idx = e.currentTarget.dataset.idx
    console.log(idx)
    pics.splice(idx, 1)
    imagesPress.splice(idx, 1)
    this.setData({
        pics: pics,
        imagesPress: imagesPress
    })
  },
})
```

